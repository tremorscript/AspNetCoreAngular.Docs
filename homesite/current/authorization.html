<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Authentication and Authorization :: AspNetCoreAngular Developer Documentation</title>
    <link rel="canonical" href="https://tremorscript.com/homesite/current/authorization.html">
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://tremorscript.com">AspNetCoreAngular Developer Documentation</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="homesite" data-version="1.0.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Home page</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="code-quality-guidelines.html">Code Quality Guidelines</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="pull-request-guidelines.html">Pull Request Guidelines</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="content-security-policy.html">Content Security Policy</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="authorization.html">Authentication and Authorization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="configuration-management.html">Configuration Management</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="error-handling.html">Error Handling</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="internationalization.html">Internationalization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="unit-testing.html">Performance Testing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="functional-testing.html">Functional Testing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="e2e-testing.html">End-to-End Testing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="property-based-testing.html">Property Based Testing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="performance-testing.html">Performance Testing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="owasp-top10.html">OWASP Top 10</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="threat-modeling.html">Threat Modeling</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="api-versioning.html">Api Versioning Policy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="release-policy.html">Release Policy</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Home page</span>
    <span class="version">1.0.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">Home page</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">1.0.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Home page</a></li>
    <li><a href="authorization.html">Authentication and Authorization</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/tremorscript/AspNetCoreAngular.Docs/edit/main/modules/ROOT/pages/authorization.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="4">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Authentication and Authorization</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are 3 actors involved when it comes to authentication and authorization.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The angular application (the client)</p>
</li>
<li>
<p>The webapi (the resource)</p>
</li>
<li>
<p>IdentityServer4 (the Identity Provider also the Secure Token Service)</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sts_project"><a class="anchor" href="#_sts_project"></a>STS Project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, we see how the client is configured in the STS project.</p>
</div>
<div class="paragraph">
<p>In the <code>ConfigureServices</code> method of <code>Startup.cs</code>, the <code>AddStsServer</code> extension method of <code>IServiceCollection</code> is called.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">public void ConfigureServices(IServiceCollection services)
{
    services.AddTransient&lt;IProfileService, CustomProfileService&gt;();
    services.AddTransient&lt;IIdentitySeedData, IdentitySeedData&gt;();

    services
        .AddApplication()
        .AddInfrastructure(Configuration, this.HostingEnvironment)
        .AddHealthChecks()
        .AddDbContextCheck&lt;IdentityServerDbContext&gt;();

    services.AddStsServer(Configuration, this.HostingEnvironment);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>AddStsServer</code> method is defined in the <code>ServicesExtensions.cs</code> class in the project.</p>
</div>
<div class="paragraph">
<p>Here, the angular client is configured as a valid client with access to the WebApi resource.</p>
</div>
<div class="paragraph">
<p>For now, the clientid and the resource name are the same. Need to change that.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">var clientId = client.clientId;
var host = client.corsOrigin;
var spaClient = options.Clients.AddSPA(
    clientId,
    spa =&gt;
        spa.WithRedirectUri($"{host}/authentication/login-callback")
            .WithScopes(new string[] { clientId })
            .WithLogoutRedirectUri($"{host}/authentication/logout-callback"));

spaClient.AlwaysIncludeUserClaimsInIdToken = true;

options.ApiResources.AddApiResource(
    clientId,
    resource =&gt;
    {
        resource.WithScopes(
            clientId,
            IdentityServerConstants.StandardScopes.Email);
    });</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_web_project"><a class="anchor" href="#_web_project"></a>Web Project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the <code>Startup.cs</code> class of the web api services, we configure the authentication to use JWT tokens.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">services
    .AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =&gt;
    {
        // base-address of your identity server
        options.Authority = Configuration["Auth:Authority"];

        // name of the API resource
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidAudiences = Configuration

                // the name of the resource as configured in the STS project
                .GetSection("Auth:Audiences")
                .Get&lt;List&lt;string&gt;&gt;(),
        };
        options.RequireHttpsMetadata = false;
    });</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the <code>ApiControllers</code> in the application inherit from the <code>BaseController</code> which has the <code>[Authorize]</code> attribute.</p>
</div>
<div class="paragraph">
<p>If you need an <code>ApiController</code> that does not need authorization, then add <code>[AllowAnonymous]</code> attrbute to the controller class. See <code>AppController.cs</code> as an example.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_clientappangular_application"><a class="anchor" href="#_the_clientappangular_application"></a>The ClientApp(Angular) application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are two main actors involved:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>AuthInterceptor.ts</p>
</li>
<li>
<p>login.component.ts</p>
</li>
<li>
<p>AuthorizeService.ts</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_authinterceptor"><a class="anchor" href="#_authinterceptor"></a>AuthInterceptor</h3>
<div class="paragraph">
<p>The <code>AuthInterceptor</code> looks for  is quite simple. If it receives a response with status code '401 - Unauthorized', it navigates to the <code>LoginComponent</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ts hljs" data-lang="ts">export class AuthInterceptor implements HttpInterceptor {
  constructor(private router: Router) {}

  intercept(req: HttpRequest&lt;any&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;any&gt;&gt; {
    return next.handle(req).pipe(
      catchError((error: HttpErrorResponse) =&gt; {
        if (error.status === 401) { <i class="conum" data-value="1"></i><b>(1)</b>
          this.router.navigate(['/authentication/login']); <i class="conum" data-value="2"></i><b>(2)</b>
        }
        return throwError(error);
      }),
    );
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Check for error status 401.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Navigate to <code>LoginComponent</code>. The route is defined in <code>shared.module.ts</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_logincomponent"><a class="anchor" href="#_logincomponent"></a>LoginComponent</h3>
<div class="paragraph">
<p>The <code>ngInit</code> method of the <code>LoginComponent</code> checks to see which url was called and calls the appropriate method in <code>AuthorizeService.ts</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_authorizeservice"><a class="anchor" href="#_authorizeservice"></a>AuthorizeService</h3>
<div class="paragraph">
<p>The <code>AuthorizeService</code> is the service class that handles the <code>IUser</code> object and general authorization tasks like sign-in and sign-out.</p>
</div>
<div class="sect3">
<h4 id="_private_variables"><a class="anchor" href="#_private_variables"></a>private variables</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ts hljs" data-lang="ts">  private _user: IUser; <i class="conum" data-value="1"></i><b>(1)</b>
  private popUpDisabled = true; <i class="conum" data-value="2"></i><b>(2)</b>
  private userManager: UserManager; <i class="conum" data-value="3"></i><b>(3)</b>
  private userSubject: BehaviorSubject&lt;IUser | null&gt; = new BehaviorSubject(null); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>IUser</code> is an interface that extends from the <code>User</code> class of the <code>oidc-client-ts</code> library. It has 2 properties - the name of the user and a list of roles attached to the user.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If you would like to enable authentication using a popup then enable this flag. It is disabled by default because users generally do not have popups enabled.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>UserManager</code> is the class provided by the <code>oidc-client-ts</code> library that manages the <code>User</code> object. It provides the methods that help add a user, remove a user, sign-in a user etc.. <a href="https://authts.github.io/oidc-client-ts/classes/UserManager.html" target="_blank" rel="noopener">A complete list of all the methods provided by UserManager.</a></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>A <code>BehaviourSubject</code> that publishes an <code>IUser</code> when signed in and publishes a <code>null</code> when the user signs-out or if the user has not signed-in yet. If subscribers would like to listen for changes to the logged-in state of a user, they can call the <code>getUser</code> method (discussed later) which returns an <code>Observable</code> of this <code>BehaviourSubject</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_signin_method"><a class="anchor" href="#_signin_method"></a>signIn method</h4>
<div class="paragraph">
<p>This method is called by the <code>LoginComponent</code> when the user gets redirected to <code>authentication/login</code> by the <code>AuthInterceptor</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ts hljs" data-lang="ts">public async signIn(state: any): Promise&lt;IAuthenticationResult&gt; {
    await this.ensureUserManagerInitialized(); <i class="conum" data-value="1"></i><b>(1)</b>
    let user: User = null;
    try {
      user = await this.userManager.signinSilent(this.createArguments()); <i class="conum" data-value="2"></i><b>(2)</b>
      this.userSubject.next(user.profile as any); <i class="conum" data-value="3"></i><b>(3)</b>
      return this.success(state); <i class="conum" data-value="4"></i><b>(4)</b>
    } catch (silentError) {
      // User might not be authenticated, fallback to popup authentication
      console.log('Silent authentication error: ', silentError);

      try {
        if (this.popUpDisabled) { <i class="conum" data-value="5"></i><b>(5)</b>
          throw new Error("Popup disabled. Change 'authorize.service.ts:AuthorizeService.popupDisabled' to false to enable it.");
        }
        user = await this.userManager.signinPopup(this.createArguments()); <i class="conum" data-value="6"></i><b>(6)</b>
        this.userSubject.next(user.profile as any);
        return this.success(state);
      } catch (popupError) {
        if (popupError.message === 'Popup window closed') {
          // The user explicitly cancelled the login action by closing an opened popup.
          return this.error('The user closed the window.');
        } else if (!this.popUpDisabled) {
          console.log('Popup authentication error: ', popupError);
        }

        // PopUps might be blocked by the user, fallback to redirect
        try {
          await this.userManager.signinRedirect(this.createArguments(state)); <i class="conum" data-value="7"></i><b>(7)</b>
          return this.redirect(); <i class="conum" data-value="8"></i><b>(8)</b>
        } catch (redirectError) {
          console.log('Redirect authentication error: ', redirectError);
          return this.error(redirectError);
        }
      }
    }
  }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Makes sure that <code>this.userManager</code> is not null and initialized to some basic settings.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Try to authenticate the user silently. This is a success if the user is already logged in to the Identity Provider.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>user.profile</code> returns an object that integrates the <code><a href="https://authts.github.io/oidc-client-ts/interfaces/IdTokenClaims.html" target="_blank" rel="noopener">IDTokenClaims</a></code> with <code>IUser</code> and publishes it to subscribers.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Returns an <code>IAuthenticationResult</code> with the status as Success.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Checks if the the popup is disabled.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Opens the <code>signinPopup</code></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Redirects the user to the Identity Providers sign in page. The state is an object that contains the redirect url.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Returns an <code>IAuthenticationResult</code> with the status as Redirect.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_completesignin_method"><a class="anchor" href="#_completesignin_method"></a>completeSignIn method</h4>
<div class="paragraph">
<p>This method is called by the <code>LoginComponent</code> when the Identity Provider validates the user successfully and calls the login-callback url - <code>authentication/login-callback</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ts hljs" data-lang="ts">public async completeSignIn(url: string): Promise&lt;IAuthenticationResult&gt; {
  try {
    await this.ensureUserManagerInitialized(); <i class="conum" data-value="1"></i><b>(1)</b>
    const user = await this.userManager.signinCallback(url); <i class="conum" data-value="2"></i><b>(2)</b>
    this.userSubject.next(user &amp;&amp; (user.profile as any)); <i class="conum" data-value="3"></i><b>(3)</b>
    return this.success(user &amp;&amp; user.state); <i class="conum" data-value="4"></i><b>(4)</b>
  } catch (error) {
    console.log('There was an error signing in: ', error);
    return this.error('There was an error signing in.');
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Makes sure that <code>this.userManager</code> is not null and initialized to some basic settings.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>url</code> to return to once the <code>User</code> object is populated. If the sign-in happened in a popup, it notifies the parent window of the response from the authorization endpoint.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Publish the <code>User</code> object.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Return <code>IAuthenticationResult.Success</code> with the <code>state</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_signout_method"><a class="anchor" href="#_signout_method"></a>signOut method</h4>
<div class="paragraph">
<p>This method is called by the <code>LogoutComponent</code> when the user gets redirected to <code>authentication/logout</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ts hljs" data-lang="ts">public async signOut(state: any): Promise&lt;IAuthenticationResult&gt; {
  try {
    if (this.popUpDisabled) {
      throw new Error("Popup disabled. Change 'authorize.service.ts:AuthorizeService.popupDisabled' to false to enable it.");
    }

    await this.ensureUserManagerInitialized(); <i class="conum" data-value="1"></i><b>(1)</b>
    await this.userManager.signoutPopup(this.createArguments()); <i class="conum" data-value="2"></i><b>(2)</b>
    this.userSubject.next(null); <i class="conum" data-value="3"></i><b>(3)</b>
    return this.success(state); <i class="conum" data-value="4"></i><b>(4)</b>
  } catch (popupSignOutError) {
    console.log('Popup signout error: ', popupSignOutError);
    try {
      await this.userManager.signoutRedirect(this.createArguments(state)); <i class="conum" data-value="5"></i><b>(5)</b>
      return this.redirect(); <i class="conum" data-value="6"></i><b>(6)</b>
    } catch (redirectSignOutError) {
      console.log('Redirect signout error: ', popupSignOutError);
      return this.error(redirectSignOutError);
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Makes sure that <code>this.userManager</code> is not null and initialized to some basic settings.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Popup logout if enabled. <code>useReplaceToNavigate</code> is set to true by the <code>createArguments</code> method and passed to <code>signoutPopup</code>. It allows <code>location.replace</code> when using <code>signinRedirect</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Successful logout publishes <code>null</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Return <code>IAuthenticationResult.Success</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Redirects the user to the Identity Providers sign in page. The state is an object that contains the redirect url.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Return <code>IAuthenticationResult.Redirect</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_completesignout_method"><a class="anchor" href="#_completesignout_method"></a>completeSignOut method</h4>
<div class="paragraph">
<p>This method is called by the <code>LogoutComponent</code> when the Identity Provider calls the logout-callback url - <code>authentication/logout-callback</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ts hljs" data-lang="ts">public async completeSignOut(url: string): Promise&lt;IAuthenticationResult&gt; {
  await this.ensureUserManagerInitialized(); <i class="conum" data-value="1"></i><b>(1)</b>
  try {
    await this.userManager.signoutCallback(url); <i class="conum" data-value="2"></i><b>(2)</b>
    this.userSubject.next(null); <i class="conum" data-value="3"></i><b>(3)</b>
    return this.success({}); <i class="conum" data-value="4"></i><b>(4)</b>
  } catch (error) {
    console.log(`There was an error trying to log out '${error}'.`);
    return this.error(error);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Makes sure that <code>this.userManager</code> is not null and initialized to some basic settings.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>url</code> to return to once the <code>User</code> object is populated. If the sign-out happened in a popup, it notifies the parent window of the response from the authorization endpoint.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Publish null.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Return <code>IAuthenticationResult.Success</code> with a blank <code>state</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_ensureusermanagerinitialized_method"><a class="anchor" href="#_ensureusermanagerinitialized_method"></a>ensureUserManagerInitialized method</h4>
<div class="paragraph">
<p>This is a private method called by the above public methods. This method makes sure that the <code>userManager</code> object is intialized with some basic settings.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ts hljs" data-lang="ts">private async ensureUserManagerInitialized(): Promise&lt;void&gt; {
  if (this.userManager !== undefined) {
    return;
  }
  const response = await fetch(ApplicationPaths.ApiAuthorizationClientConfigurationUrl); <i class="conum" data-value="1"></i><b>(1)</b>
  if (!response.ok) {
    throw new Error(`Could not load settings for ''`);
  }

  const settings: any = await response.json();
  settings.automaticSilentRenew = true;
  settings.includeIdTokenInSilentRenew = true;
  this.userManager = new UserManager(settings);

  this.userManager.events.addUserSignedOut(async () =&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
    await this.userManager.removeUser();
    this.userSubject.next(null);
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This fetches a few settings from the STS - <code>${environment.stsUrl}_configuration</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Subscribe to the <code>addUserSignedOut</code> event to remove the user and publish null.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_getuser_method"><a class="anchor" href="#_getuser_method"></a>getUser method</h4>
<div class="paragraph">
<p>This method returns an <code>IObservable&lt;IUser&gt;</code>. Use this method to get the latest user and subscribe to any changes to the <code>IUser</code> object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ts hljs" data-lang="ts">public getUser(): Observable&lt;IUser | null&gt; {
   return concat( <i class="conum" data-value="1"></i><b>(1)</b>
     this.userSubject.pipe( <i class="conum" data-value="2"></i><b>(2)</b>
       take(1),
       filter(u =&gt; !!u),
     ),
     this.getUserFromStorage().pipe( <i class="conum" data-value="3"></i><b>(3)</b>
       filter(u =&gt; !!u),
       tap(u =&gt; {
         this._user = u;
         this.userSubject.next(u);
       }),
     ),
     this.userSubject.asObservable(), <i class="conum" data-value="4"></i><b>(4)</b>
   );
 }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The concat method returns all the three <code>IObservable&lt;IUser&gt;</code> one after the other.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Returns the user if already subscribed.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Gets the user from storage.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Returns the observable</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_getuserfromstorage_method"><a class="anchor" href="#_getuserfromstorage_method"></a>getUserFromStorage method</h4>
<div class="paragraph">
<p>This method returns a user stored by the <code>this.userManager</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ts hljs" data-lang="ts">  private getUserFromStorage(): Observable&lt;IUser&gt; {
    return from(this.ensureUserManagerInitialized()).pipe(
      mergeMap(() =&gt; this.userManager.getUser()),
      map(u =&gt; u &amp;&amp; (u.profile as any)),
    );
  }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_getaccesstoken_method"><a class="anchor" href="#_getaccesstoken_method"></a>getAccessToken method</h4>
<div class="paragraph">
<p>In case you need to view the access token, this is the method to use.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ts hljs" data-lang="ts">public getAccessToken(): Observable&lt;string&gt; {
  return from(this.ensureUserManagerInitialized()).pipe(
    mergeMap(() =&gt; from(this.userManager.getUser())),
    map(user =&gt; user &amp;&amp; user.access_token),
  );
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
